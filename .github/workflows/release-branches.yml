name: Release Branches

on:
  workflow_dispatch:

jobs:
  release-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Compute versions
        id: ver
        run: |
          MAIN_VER=$(node -e "console.log(require('./package.json').version)")
          IFS='.' read MAJ MIN PAT <<<"$MAIN_VER"
          TP=$((PAT-5)); [ $TP -lt 0 ] && TP=0
          TRIAL_VER="$MAJ.$MIN.$TP"
          NM=$((MIN-1)); [ $NM -lt 0 ] && NM=0
          NOLOCK_VER="$MAJ.$NM.$PAT"
          echo "MAIN_VER=$MAIN_VER" >> $GITHUB_OUTPUT
          echo "TRIAL_VER=$TRIAL_VER" >> $GITHUB_OUTPUT
          echo "NOLOCK_VER=$NOLOCK_VER" >> $GITHUB_OUTPUT

      - name: Show versions
        run: |
          echo "Main:   ${{ steps.ver.outputs.MAIN_VER }}"
          echo "Trial:  ${{ steps.ver.outputs.TRIAL_VER }}"
          echo "NoLock: ${{ steps.ver.outputs.NOLOCK_VER }}"

      - name: Set git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 可选：如 main 已手动更新版本，可注释此步骤
      - name: Update main version (optional)
        run: |
          jq '.version = "${{ steps.ver.outputs.MAIN_VER }}"' package.json > /tmp/pkg && mv /tmp/pkg package.json
          jq '.version = "${{ steps.ver.outputs.MAIN_VER }}"' public/plugin.json > /tmp/plugin && mv /tmp/plugin public/plugin.json
          git add package.json public/plugin.json
          git commit -m "chore: set main version ${{ steps.ver.outputs.MAIN_VER }}" || echo "no main changes"

      - name: Push trial branch
        run: |
          git checkout main
          git checkout -B trial
          echo "VITE_LOCK_PROFILE=trial" > .env
          jq '.version = "${{ steps.ver.outputs.TRIAL_VER }}"' package.json > /tmp/pkg && mv /tmp/pkg package.json
          jq '.version = "${{ steps.ver.outputs.TRIAL_VER }}"' public/plugin.json > /tmp/plugin && mv /tmp/plugin public/plugin.json
          git add package.json public/plugin.json .env
          git commit -m "chore: trial version ${{ steps.ver.outputs.TRIAL_VER }}" || echo "no trial changes"
          git push -u origin trial --force

      - name: Push nolock branch
        run: |
          git checkout main
          git checkout -B nolock
          echo "VITE_LOCK_PROFILE=nolock" > .env
          jq '.version = "${{ steps.ver.outputs.NOLOCK_VER }}"' package.json > /tmp/pkg && mv /tmp/pkg package.json
          jq '.version = "${{ steps.ver.outputs.NOLOCK_VER }}"' public/plugin.json > /tmp/plugin && mv /tmp/plugin public/plugin.json
          git add package.json public/plugin.json .env
          git commit -m "chore: nolock version ${{ steps.ver.outputs.NOLOCK_VER }}" || echo "no nolock changes"
          git push -u origin nolock --force
