name: Release Multi Variant

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check latest release vs package version
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PKG_VER=$(node -e "console.log(require('./package.json').version)")
          RESP=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" https://api.github.com/repos/${{ github.repository }}/releases/latest)
          LATEST_TAG=$(echo "$RESP" | jq -r '.tag_name // ""')
          if [ "$LATEST_TAG" = "null" ]; then LATEST_TAG=""; fi
          # only compare against main release tags (strip leading v and any suffix)
          LATEST_VER=$(echo "$LATEST_TAG" | sed 's/^v//' | sed 's/-.*//')
          DECISION=$(python .github/scripts/compare_version.py "$PKG_VER" "$LATEST_VER")
          echo "package_version=$PKG_VER" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VER" >> $GITHUB_OUTPUT
          if [ "$DECISION" = "release" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "Releasing: package $PKG_VER is newer than latest $LATEST_VER"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Skip release: package $PKG_VER <= latest $LATEST_VER"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
        if: steps.check_release.outputs.should_release == 'true'

      - name: Install deps
        run: npm ci
        if: steps.check_release.outputs.should_release == 'true'

      - name: Test base build
        run: npm run build
        if: steps.check_release.outputs.should_release == 'true'

      - name: Compute versions
        id: ver
        run: |
          MAIN_VER=$(node -e "console.log(require('./package.json').version)")
          IFS='.' read MAJ MIN PAT <<<"$MAIN_VER"
          TRIAL_ENABLED=0
          NOLOCK_ENABLED=0
          if [ $((PAT % 2)) -eq 0 ]; then TRIAL_ENABLED=1; fi
          if [ $((PAT % 5)) -eq 0 ]; then NOLOCK_ENABLED=1; fi
          echo "MAIN_VER=$MAIN_VER"   >> $GITHUB_OUTPUT
          echo "TRIAL_VER=$MAIN_VER" >> $GITHUB_OUTPUT
          echo "NOLOCK_VER=$MAIN_VER" >> $GITHUB_OUTPUT
          echo "TRIAL_ENABLED=$TRIAL_ENABLED" >> $GITHUB_OUTPUT
          echo "NOLOCK_ENABLED=$NOLOCK_ENABLED" >> $GITHUB_OUTPUT
        if: steps.check_release.outputs.should_release == 'true'

      - name: Build main
        run: |
          rm -rf artifacts build-upx && mkdir -p artifacts build-upx/main
          VITE_APP_VERSION=${{ steps.ver.outputs.MAIN_VER }} \
          VITE_APP_BRANCH=main \
          npm run build
          cp -R dist/* build-upx/main/
          cp plugin.json build-upx/main/
          [ -f credits.html ] && cp credits.html build-upx/main/ || true
          [ -f credits.en.html ] && cp credits.en.html build-upx/main/ || true
          (cd build-upx/main && zip -r ../../artifacts/main.upx .)
        if: steps.check_release.outputs.should_release == 'true'

      - name: Build trial (10m lock)
        if: steps.check_release.outputs.should_release == 'true' && steps.ver.outputs.TRIAL_ENABLED == '1'
        run: |
          git checkout -- package.json public/plugin.json .env || true
          jq '.version = "${{ steps.ver.outputs.TRIAL_VER }}"' package.json > /tmp/pkg && mv /tmp/pkg package.json
          jq '.version = "${{ steps.ver.outputs.TRIAL_VER }}"' public/plugin.json > /tmp/plugin && mv /tmp/plugin public/plugin.json
          rm -rf build-upx/trial && mkdir -p build-upx/trial
          VITE_LOCK_PROFILE=trial \
          VITE_APP_VERSION=${{ steps.ver.outputs.TRIAL_VER }} \
          VITE_APP_BRANCH=trial \
          npm run build
          cp -R dist/* build-upx/trial/
          cp plugin.json build-upx/trial/
          [ -f credits.html ] && cp credits.html build-upx/trial/ || true
          [ -f credits.en.html ] && cp credits.en.html build-upx/trial/ || true
          (cd build-upx/trial && zip -r ../../artifacts/trial.upx .)

      - name: Build nolock
        if: steps.check_release.outputs.should_release == 'true' && steps.ver.outputs.NOLOCK_ENABLED == '1'
        run: |
          git checkout -- package.json public/plugin.json .env || true
          jq '.version = "${{ steps.ver.outputs.NOLOCK_VER }}"' package.json > /tmp/pkg && mv /tmp/pkg package.json
          jq '.version = "${{ steps.ver.outputs.NOLOCK_VER }}"' public/plugin.json > /tmp/plugin && mv /tmp/plugin public/plugin.json
          rm -rf build-upx/nolock && mkdir -p build-upx/nolock
          VITE_LOCK_PROFILE=nolock \
          VITE_APP_VERSION=${{ steps.ver.outputs.NOLOCK_VER }} \
          VITE_APP_BRANCH=nolock \
          npm run build
          cp -R dist/* build-upx/nolock/
          cp plugin.json build-upx/nolock/
          [ -f credits.html ] && cp credits.html build-upx/nolock/ || true
          [ -f credits.en.html ] && cp credits.en.html build-upx/nolock/ || true
          (cd build-upx/nolock && zip -r ../../artifacts/nolock.upx .)

      - name: Create release main
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.ver.outputs.MAIN_VER }}
          name: eSIM 管理工具 v${{ steps.ver.outputs.MAIN_VER }} (main)
          draft: false
          prerelease: false
          files: artifacts/main.upxs
        if: steps.check_release.outputs.should_release == 'true'

      - name: Create release trial
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.ver.outputs.TRIAL_VER }}-trial
          name: eSIM 管理工具 v${{ steps.ver.outputs.TRIAL_VER }} (trial)
          draft: false
          prerelease: true
          files: artifacts/trial.upxs
        if: steps.check_release.outputs.should_release == 'true'

      - name: Create release nolock
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.ver.outputs.NOLOCK_VER }}-nolock
          name: eSIM 管理工具 v${{ steps.ver.outputs.NOLOCK_VER }} (nolock)
          draft: false
          prerelease: true
          files: artifacts/nolock.upxs
        if: steps.check_release.outputs.should_release == 'true'
